name: Generate Service

on:
  push:
    branches:
      - main
    paths:
      - 'sources-service/**'

jobs:
  detect-new-services:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Cáº§n fetch 2 commits Ä‘á»ƒ so sÃ¡nh
      
      - name: Detect new service folders
        id: detect
        run: |
          echo "ðŸ” Checking for new service folders..."
          
          # Láº¥y danh sÃ¡ch files thay Ä‘á»•i giá»¯a commit hiá»‡n táº¡i vÃ  commit trÆ°á»›c
          # Chá»‰ láº¥y nhá»¯ng file má»›i Ä‘Æ°á»£c thÃªm (A = Added)
          CHANGED_FILES=$(git diff --name-status --diff-filter=A HEAD~1 HEAD -- sources-service/)
          
          echo "ðŸ“ Added files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Lá»c ra cÃ¡c folder má»›i (láº¥y tÃªn folder tá»« path)
          # Format: sources-service/{folder_name}/source.yml
          NEW_FOLDERS=$(echo "$CHANGED_FILES" | \
            grep -E "^A\s+sources-service/[^/]+/source\.yml$" | \
            sed 's|A[[:space:]]*sources-service/\([^/]*\)/source\.yml|\1|' | \
            sort -u)
          
          echo "ðŸ†• New service folders detected:"
          echo "$NEW_FOLDERS"
          echo ""
          
          if [ -z "$NEW_FOLDERS" ]; then
            echo "âŒ No new service folders found."
            echo "has_new_services=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found new service folders!"
            echo "has_new_services=true" >> $GITHUB_OUTPUT
            
            # LÆ°u danh sÃ¡ch Ä‘á»ƒ step sau dÃ¹ng
            echo "new_services<<EOF" >> $GITHUB_OUTPUT
            echo "$NEW_FOLDERS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi