name: Generate Service

on:
  push:
    branches:
      - main
    paths:
      - 'sources-service/**'

jobs:
  detect-new-services:
    runs-on: ubuntu-latest
    outputs:
      new_services: ${{ steps.detect.outputs.new_services }}
      has_new_services: ${{ steps.detect.outputs.has_new_services }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Cáº§n fetch 2 commits Ä‘á»ƒ so sÃ¡nh
      
      - name: Detect new service folders
        id: detect
        run: |
          echo "ğŸ” Checking for new service folders..."
          
          # Láº¥y danh sÃ¡ch files thay Ä‘á»•i giá»¯a commit hiá»‡n táº¡i vÃ  commit trÆ°á»›c
          # Chá»‰ láº¥y nhá»¯ng file má»›i Ä‘Æ°á»£c thÃªm (A = Added)
          CHANGED_FILES=$(git diff --name-status --diff-filter=A HEAD~1 HEAD -- sources-service/)
          
          echo "ğŸ“ Added files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Lá»c ra cÃ¡c folder má»›i (láº¥y tÃªn folder tá»« path)
          # Format: sources-service/{folder_name}/source.yml
          NEW_FOLDERS=$(echo "$CHANGED_FILES" | \
            grep -E "^A\s+sources-service/[^/]+/source\.yml$" | \
            sed 's|A[[:space:]]*sources-service/\([^/]*\)/source\.yml|\1|' | \
            sort -u)
          
          echo "ğŸ†• New service folders detected:"
          echo "$NEW_FOLDERS"
          echo ""
          
          if [ -z "$NEW_FOLDERS" ]; then
            echo "âŒ No new service folders found."
            echo "has_new_services=false" >> $GITHUB_OUTPUT
            echo "new_services=" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found new service folders!"
            echo "has_new_services=true" >> $GITHUB_OUTPUT
            
            # LÆ°u danh sÃ¡ch Ä‘á»ƒ job sau dÃ¹ng (newline separated)
            echo "new_services<<EOF" >> $GITHUB_OUTPUT
            echo "$NEW_FOLDERS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

  process-new-services:
    needs: detect-new-services
    if: needs.detect-new-services.outputs.has_new_services == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install dependencies
        run: go mod tidy
      
      - name: Process each new service
        run: |
          echo "ğŸš€ Processing new services..."
          echo ""
          
          # Äá»c danh sÃ¡ch services tá»« output cá»§a job trÆ°á»›c
          SERVICES="${{ needs.detect-new-services.outputs.new_services }}"
          
          echo "$SERVICES" | while read service; do
            if [ -n "$service" ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“¦ Processing: $service"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # Cháº¡y Go script Ä‘á»ƒ Ä‘á»c source.yml vÃ  print DTO
              go run scripts/generate_source.go "sources-service/$service"
              
              echo ""
            fi
          done
          
          echo "âœ… All services processed!"
